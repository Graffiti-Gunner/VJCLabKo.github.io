
　AutoLuminous 上級編



※この文書では3DCG用語、DirectX用語、MME用語が
　説明なく登場しますがご了承ください。


■ AutoLuminous 基本構造

AutoLuminousの実態はHDR描画エンジンです。
色情報はすべて浮動小数点で扱われ、0〜1を超える範囲の色を
扱うことが可能です。そして、1を超える色は高輝度部分として
ブルームやグレアの処理が行われます。

AL_EmitterRT は意図的に高輝度部分を付加するための
フロントエンドに過ぎません。


■ キーカラー発光

KeyLuminousと同様、キーカラーを指定して任意の色に発光させることができます。
エフェクトを開き、以下の3つのパラメータを編集します。

・KeyThreshold
　色の判定に使われる閾値です。

・KEYCOLOR_NUM
　キーカラーの数です。
　0を指定するとキーカラー発光は無効になります。

・KeyColors
　キーカラーの配列です。
　コメント文に従って、キー色,コア色,発光色の3つを追加します。
　必ずKEYCOLOR_NUMで指定した数だけ設定する必要があります。
　ただしKEYCOLOR_NUMが0の場合はパラメータそのものが無視されるので
　どうなっていてもOKです。
　

■ 表情による個別発光制御

PMDまたはPMXモデルの場合、以下のような名前のダミー表情を
モデルに組み込むことで、モデル個別に発光を制御できます。
必要なものだけ選んでもかまいません。

・LightUp
・LightOff
・LightBlink
・LightBS
・LightUpE (New!)
・LightDuty (New!)
・LightMin (New!)

"LightUp"および"LightOff"では光量を調整できます。
LightUpでは最大3倍まで明るくなります。
LightOffではMAXで完全に発光が消えます。

"LightBlink"および"LightBS"というダミー表情を使うと、
発光の点滅をモデル個別制御できます。
"LightBlink"はサイン波点滅、LightBSは矩形波点滅をします。
最大で10秒間隔になります。

"LightUpE"では、明るさが指数関数的に上昇します。
最大で400倍まで上昇します。
"LightDuty"は点滅のオンとオフの比率を変えることができます。
"LightMin"は点滅時の最小明るさを設定できます。


これらダミー表情が使えるのはスペキュラ強度を利用して発光指定した場合だけです。



■ 頂点発光機能

PMXのみ、追加UVを用いて頂点ごとの発光制御を行うことができます。
材質指定より柔軟に設定できますが、改造やデータ管理は煩雑になります。

・追加UV1
　・X:0.2, Y:0.7
　　AutoLuminous用の追加UVデータであることを示す識別コードです。
　　この値は固定です。
　・Z:点滅周期
　　点滅周期を秒で指定します。
　　マイナスの値では矩形波点滅になります。
　・W:フラグ
　　フラグを指定します。
　　現状では、1を指定すると発光に対するテクスチャの乗算がされなくなります。

・追加UV2
　・X:赤, Y:緑, Z:青
　　発光色を指定します。
　・W:発光強度
　　発光強度を指定します。基準は1です。


　Optionsフォルダに、PMDEでの選択頂点の追加UVを一括変更するスクリプトを同梱します。
　プラグイン > CSSScript から読み込み、適当に値を書き換えて実行してください。


■ PMDEによるアクセサリ編集

・PMDEを起動して、編集したいXファイルをドラッグ＆ドロップします。
・「新規」「10倍」で読み込みます。
・材質などを編集します。
　MMDでアクセサリとして読み込んだ時と表示のされ方が違うので注意。
・メニューから「ファイル」→「エクスポート」を選び、名前を付けて保存します。
・サイズを「1/10倍」を選んで出力。
・PMDEを終了します。未保存の警告が出ますが無視してOKです。


■ マスク機能

特定のオブジェクトを発光の影響を受けないように設定できます。
まずは、エフェクトを開いて MASK_ENABLE オプションを1に設定します。
するとMMEの設定タブに"AL_MaskRT"が出現するので、
発光の影響を受けないようにしたいオブジェクトを選んで右クリックし
「解除」をクリックします。

発光しているオブジェクトにマスクを適用すると、
後光やオーラのような表現になります。


■ 残光機能

エフェクトを開き、AFTERGLOWを0以上の値にすると残光機能が有効になります。
フレームブレンド方式のため、あまり高速移動させると不連続になってしまいます。
出力FPSを上げるなどして対応してください。


■ テクスチャの異方性フィルタリング対応

複雑なテクスチャを適用した材質を光らせると、テクスチャの縮小の影響で
発光がチラつくことがあります。
AL_Object.fxsub の MIPMAPTEX_SIZE を変更すると
異方性フィルタリングが有効になり、チラつきを緩和できることがあります。
値はモデルに使用されているテクスチャの最大サイズと同じぐらいが推奨されますが、
大きすぎると重くなります。
また、全体的にぼやける副作用があります。


■ テクスチャ高輝度部分発光

発光させたい部分がテクスチャ上に描かれていて材質として分離できないとき、
MMEのAL_EmitterRTタブから目的のモデルまたは材質を選んで
付属のAL_Texture.fxを適用すると、テクスチャの明るいところだけ発光するように
設定できます。
ただし、細かい調整が必要なことが多いです。


■ トーンカーブ変更

ToneCurve.x を読み込むとAutoLuminousのトーンカーブが変更され、
白飛びを起こしにくくなります。
ただし元スクリーンのコントラストを落とすことになるので、
高輝度部分が画面上に多く存在する場合の使用を推奨します。

逆に画面が暗い場合、低輝度のトーンカーブは直線のままなので
コントラストを落とさず利用できます。

SCREEN_TONECURVEを1にすることでトーンカーブを強制オンにできます。


■ テストモード

AL_Test.xを読み込むとAutoLuminousはテストモードになり、
ぼかしを入れる前の高輝度部分のみを表示します。



■ 加算合成による高輝度付加

加算合成に設定したアクセサリやモデルによって色が1を超えた部分は
通常では1にクランプされるだけですが、AutoLuminousでは
レンダーターゲットの変更によりMMD側の描画であっても1を超える情報を
取り扱うことが可能で、高輝度部分として扱われるようになります。

ただし、加算合成でない通常の描画では、シェーダ内で値がクランプされる
ため、例えば照明を通常より明るくしたとしても高輝度部分は発生しません。

シェーダを独自のものに置き換えた場合はこの限りではありません。


■ SpotLightとの併用

MMDのスクリーン上に加算合成するタイプのエフェクトは、
HDR処理に対応させることができます。
その代表例がSpotLightです。
通常、SpotLightで照らした場所が明るすぎるとその部分が白飛びするだけですが、
AutoLuminousより描画順を前にし、かつ間に他の(HDR未対応の)ポストエフェクトを
挟まないようにすると、高輝度部分として
ブルームやグレア効果を与えることができます。

他にもPostPointLightなどが同様に使えることを確認しています。


■ 高画質を得るために

高画質を追求するのであれば、
サンプリング数を倍ぐらいに増やした上で、
なるべく大きいサイズで出力して縮小することをお勧めします。


■ MikuMikuMoving対応

AutoLuminousはまだ仮ではありますがMikuMikuMovingに対応しています。
MikuMikuMovingでは、AutoLuminous.xではなくAutoLuminous.fxを読み込むことで
エフェクトが有効になります。

まだ一部機能が使えなかったり、MMMの今後の更新の影響を受けることがありますので
ご了承ください。

